name: "Continuous Deployment to Cloudflare Pages"
description: "Deploy to Cloudflare Pages"

inputs:
  repository:
    description: 'The GitHub repository to deploy, in the format "organization/repository"'
    required: true
  production_branch:
    description: "Production Branch"
    required: true
  build_artifact_name:
    description: "Github artifact name of the build output file"
    required: true
  output_directory:
    description: "Output Directory"
    required: true
  current_branch:
    description: "Compare if not production branch for preview deploys"
    required: true
  cloudflare_account_id:
    description: "Cloudflare account id"
    required: true
  cloudflare_api_token:
    description: "Cloudflare API token"
    required: true
  commit_sha:
    description: "Commit SHA for posting the deployment link"
    required: true
  workflow_run_id:
    description: "Workflow run id which called the action, used for fetching the build artifact"
    required: true
  statics_directory:
    description: "Directory that contains static files"
    required: false
  app_credentials:
    description: "JSON array of GitHub App ID and private key pairs in the form of { id: string, private_key: string }[]
    required: false

runs:
  using: "composite"
  steps:
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.10.0

    - name: Select random GitHub App credentials
      if: inputs.app_credentials != ''
      id: select_credentials
      shell: bash
      run: |
        # Parse the JSON array and select a random credential pair
        CREDENTIALS='${{ inputs.app_credentials }}'
        
        COUNT=$(echo $CREDENTIALS | jq '. | length')
        RANDOM_INDEX=$((RANDOM % COUNT))
        
        SELECTED_APP_ID=$(echo $CREDENTIALS | jq -r ".[$RANDOM_INDEX].id")
        SELECTED_PRIVATE_KEY=$(echo $CREDENTIALS | jq -r ".[$RANDOM_INDEX].private_key")
        
        # Set outputs
        echo "app_id=$SELECTED_APP_ID" >> $GITHUB_OUTPUT
        # Store private key as a variable
        echo "private_key<<EOF" >> $GITHUB_OUTPUT
        echo "$SELECTED_PRIVATE_KEY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "Selected GitHub App ID: $SELECTED_APP_ID"

    - name: Get GitHub App token
      if: steps.select_credentials.outputs.app_id != '' && steps.select_credentials.outputs.private_key != '' 
      uses: tibdex/github-app-token@v1.7.0
      id: get_installation_token
      with:
        app_id: ${{ steps.select_credentials.outputs.app_id }}
        private_key: ${{ steps.select_credentials.outputs.private_key }}

    - name: Find associated pull request
      id: pr
      uses: actions/github-script@v7
      with:
        github-token: ${{ steps.get_installation_token.outputs.token || github.token }}
        script: |
          const response = await github.rest.search.issuesAndPullRequests({
            q: 'repo:${{ inputs.repository }} is:pr sha:${{ inputs.commit_sha }}',
            per_page: 1,
          })
          const items = response.data.items
          if (items.length < 1) {
            console.error('No PRs found')
            return {forcePreviewDeploy: false, pullRequestNumber: null }
          }
          const pullRequestNumber = items[0].number
          const forcePreviewDeploy = pullRequestNumber > 0  && items[0].pull_request.merged_at == null
          console.info("Pull request number is", pullRequestNumber)
          console.info("forcePreviewDeploy", forcePreviewDeploy)
          return {forcePreviewDeploy: forcePreviewDeploy, pullRequestNumber: pullRequestNumber }

    - name: Download build artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        name: ${{ inputs.build_artifact_name }}
        path: ${{ inputs.output_directory }}
        run_id: ${{ inputs.workflow_run_id }}

    - name: Deploy to Cloudflare
      run: bash ../../_actions/ubiquity/cloudflare-deploy-action/main/.github/cloudflare-deploy.sh "${{ inputs.repository }}" "${{ inputs.production_branch }}" "${{ inputs.output_directory }}" "${{ fromJSON(steps.pr.outputs.result).forcePreviewDeploy && format('{0}/{1}', github.repository_owner, inputs.current_branch) || inputs.current_branch }}" "${{ inputs.statics_directory }}"
      shell: bash
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ inputs.cloudflare_account_id }}
        CLOUDFLARE_API_TOKEN: ${{ inputs.cloudflare_api_token }}

    - name: Post Deployment on Pull Request or Commit
      shell: bash
      run: |
        cd ../../_actions/ubiquity/cloudflare-deploy-action/main
        yarn
        yarn tsx src/index.ts \
        --deployment_output "${{ env.DEPLOYMENT_OUTPUT }}" \
        --repository "${{ inputs.repository }}" \
        --pull_request_number "${{ fromJSON(steps.pr.outputs.result).pullRequestNumber }}" \
        --commit_sha "${{ inputs.commit_sha }}"
